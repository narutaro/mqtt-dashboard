<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic Page Needs -->
  <meta charset="utf-8">
  <title>MQTT DASH</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <!-- Mobile Specific Metas -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- FONT -->
  <link href="//fonts.googleapis.com/css?family=Rajdhani:400,300,600" rel="stylesheet" type="text/css">
  <!-- CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/favicon.png">
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- Fontawsome -->
  <script src="https://kit.fontawesome.com/a1763a7d6f.js" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
  <script type="text/javascript" src="js/chartjs-plugin-streaming.min.js"></script>
</head>

<body>

<div class="container" style="margin-top: 40px">
  <div id="app" class="row">
    <div class="three columns"><p class="board">Time</p><h1 class="board">{{ time }}</h1></div>
    <div class="three columns"><p class="board">Power</p><h1 class="board">{{ amp }}</h1></div>
    <div class="three columns"><p class="board">Temperture</p><h1 class="board">{{ tem }}</h1></div>
    <div class="three columns"><p class="board">Humidity</p><h1 class="board">{{ hum }}</h1></div>
  </div>
  <div class="row" style="margin-top: 40px">
    <div class="twelve columns">
<!--
      <canvas id="myChart"></canvas>
-->
    </div>
  </div>
</div>

<script>

function getHHMISS(epoch){
  let dt = new Date(epoch);
  let hh = dt.getHours();
  let mi = dt.getMinutes();
  let ss = dt.getSeconds();
  hh = ("00" + hh).slice(-2);
  mi = ("00" + mi).slice(-2);
  ss = ("00" + ss).slice(-2);
  return hh + ":" + mi + ":" + ss;
}

// Vue
var app = new Vue({
  el: '#app',
  data () {
    return {
      time: '',
      amp: '',
      tem: '',
      hum: ''
    }
  },
  created: function () {
    /*
    setInterval(() => {
      this.time = getHHMISS(app.epoch)
    }, 1000);
    */

    // MQTT
    let pub = mqtt.connect('wss://test.mosquitto.org:8081');
    let sub = mqtt.connect('wss://test.mosquitto.org:8081');
    let topic = "floor1/room1"

    sub.subscribe(topic);

    setInterval(() => {
      const time = Date.now().toString();
      const amp = Math.floor( Math.random() * 11 );
      const tem = Math.floor( Math.random() * 11 );
      const hum = Math.floor( Math.random() * 11 );
      let metric = '{"time":' + time + ', "name": "sensor1", "amp":' + amp + ', "tem":' + tem + ', "hum":' + hum + '}'
      pub.publish(topic, metric);
    }, 1000);

    sub.on('message', function (topic, message) { // message is Buffer
      sensorData = JSON.parse(message.toString())
      app.time = getHHMISS(sensorData.time);
      app.amp = sensorData.amp;
      app.tem = sensorData.tem;
      app.hum = sensorData.hum;
      console.log(sensorData);
    });

    setInterval(() => {
      sub.end();
      pub.end();
    }, 20000);

  }
})


// CHART
var chartColors = {
	red: 'rgb(255, 99, 132)',
	orange: 'rgb(255, 159, 64)',
	yellow: 'rgb(255, 205, 86)',
	green: 'rgb(75, 192, 192)',
	blue: 'rgb(54, 162, 235)',
	purple: 'rgb(153, 102, 255)',
	grey: 'rgb(201, 203, 207)'
};

var ctx = document.getElementById('myChart').getContext('2d');
var chart = new Chart(ctx, {
  type: 'line',
  data: {
		datasets: [{
			label: 'Power',
			borderColor: chartColors.red,
			fill: false,
			data: []
		},
    {
			label: 'Temperture',
			borderColor: chartColors.blue,
			fill: false,
			cubicInterpolationMode: 'monotone',
			data: []
		},
    {
			label: 'Temperture',
			borderColor: chartColors.yellow,
			fill: false,
			cubicInterpolationMode: 'monotone',
			data: []
		}]
  },
  options: {
    legend: {
      position: 'bottom'
    },
    scales: {
      xAxes: [{
        type: 'realtime',
        realtime: {
          delay: 2000,
          onRefresh: function(chart) {
            chart.data.datasets.forEach(function(dataset) {
              dataset.data.push({
                x: Date.now(),
                y: Math.random()
              });
            });
          }
        }
      }]
    }
  }
});
</script>

<style>
.board {
  text-align: center;
  font-family: Rajdhani;
  font-weight: bold;
}
</style>

</body>
</html>

